apiVersion: audit.k8s.io/v1
kind: Policy
metadata:
    name: carbonxchange-audit-policy
    labels:
        app.kubernetes.io/name: carbonxchange
        app.kubernetes.io/component: compliance
    annotations:
        compliance.carbonxchange.io/description: 'Comprehensive audit policy for financial compliance'
        compliance.carbonxchange.io/standards: 'SOX,PCI-DSS,GDPR,ISO-27001'
        compliance.carbonxchange.io/retention: '7-years'
rules:
    # Log all requests at RequestResponse level for financial transactions
    - level: RequestResponse
      namespaces: ['carbonxchange', 'carbonxchange-prod']
      verbs: ['create', 'update', 'patch', 'delete']
      resources:
          - group: ''
            resources: ['secrets', 'configmaps']
          - group: 'apps'
            resources: ['deployments', 'statefulsets']
          - group: 'batch'
            resources: ['jobs', 'cronjobs']
      omitStages:
          - RequestReceived

    # Log all authentication and authorization events
    - level: Request
      users: ['system:anonymous']
      verbs: ['*']
      omitStages:
          - RequestReceived

    # Log all privileged operations
    - level: RequestResponse
      verbs: ['create', 'update', 'patch', 'delete']
      resources:
          - group: 'rbac.authorization.k8s.io'
            resources: ['roles', 'rolebindings', 'clusterroles', 'clusterrolebindings']
          - group: 'policy'
            resources: ['podsecuritypolicies']
          - group: 'networking.k8s.io'
            resources: ['networkpolicies']
      omitStages:
          - RequestReceived

    # Log all service account token requests
    - level: Request
      verbs: ['create']
      resources:
          - group: ''
            resources: ['serviceaccounts/token']
      omitStages:
          - RequestReceived

    # Log all persistent volume operations
    - level: Request
      verbs: ['create', 'update', 'patch', 'delete']
      resources:
          - group: ''
            resources: ['persistentvolumes', 'persistentvolumeclaims']
      omitStages:
          - RequestReceived

    # Log all ingress and service operations
    - level: Request
      verbs: ['create', 'update', 'patch', 'delete']
      resources:
          - group: ''
            resources: ['services']
          - group: 'networking.k8s.io'
            resources: ['ingresses']
      omitStages:
          - RequestReceived

    # Log all node operations
    - level: Request
      verbs: ['create', 'update', 'patch', 'delete']
      resources:
          - group: ''
            resources: ['nodes']
      omitStages:
          - RequestReceived

    # Log all webhook configurations
    - level: RequestResponse
      verbs: ['create', 'update', 'patch', 'delete']
      resources:
          - group: 'admissionregistration.k8s.io'
            resources: ['mutatingwebhookconfigurations', 'validatingwebhookconfigurations']
      omitStages:
          - RequestReceived

    # Log all custom resource operations
    - level: Request
      verbs: ['create', 'update', 'patch', 'delete']
      resources:
          - group: 'apiextensions.k8s.io'
            resources: ['customresourcedefinitions']
      omitStages:
          - RequestReceived

    # Log all certificate operations
    - level: Request
      verbs: ['create', 'update', 'patch', 'delete']
      resources:
          - group: 'certificates.k8s.io'
            resources: ['certificatesigningrequests']
      omitStages:
          - RequestReceived

    # Log exec, attach, and port-forward operations
    - level: Request
      verbs: ['create']
      resources:
          - group: ''
            resources: ['pods/exec', 'pods/attach', 'pods/portforward']
      omitStages:
          - RequestReceived

    # Log all operations on financial data namespaces at metadata level
    - level: Metadata
      namespaces: ['carbonxchange', 'carbonxchange-prod', 'carbonxchange-staging']
      verbs: ['get', 'list', 'watch']
      omitStages:
          - RequestReceived

    # Log all failed requests
    - level: Request
      omitStages:
          - RequestReceived
      namespaceSelector:
          matchLabels:
              compliance.carbonxchange.io/audit: 'required'

    # Default rule - log everything else at metadata level
    - level: Metadata
      omitStages:
          - RequestReceived
